# NovaBrain 3.0 Low-Code 引擎 API 设计评审 (v0.1)

*   **日期**: 2023-08-02
*   **时间**: 14:00 - 15:30
*   **地点**: 会议室 305
*   **参会人员**: 张工 (架构师), 王工 (后端负责人), 刘工 (前端负责人), 赵工 (算法工程师), 钱工 (产品经理), 孙工 (API 设计主导)
*   **主持人**: 孙工
*   **记录人**: [助理姓名]

## 评审目标

*   评审 Low-Code 引擎核心模块（可视化建模、任务编排、执行触发）的第一版 API 设计 (v0.1)。
*   确保 API 满足基本功能需求、易用性、可扩展性和一致性。
*   收集各方反馈，识别潜在问题和改进点。

## 主要讨论内容与结论

**1. 可视化建模 API (`/api/v1/lowcode/graphs`)**

*   **设计概述**: 孙工介绍了基于图的数据结构存储 pipeline 定义，提供了 CRUD 操作用于节点和边的管理。
    *   `POST /graphs`: 创建新的流程图定义。
    *   `GET /graphs/{graph_id}`: 获取流程图定义。
    *   `PUT /graphs/{graph_id}`: 更新流程图定义 (全量替换)。
    *   `DELETE /graphs/{graph_id}`: 删除流程图定义。
    *   `POST /graphs/{graph_id}/nodes`: 添加节点。
    *   `PUT /graphs/{graph_id}/nodes/{node_id}`: 更新节点属性。
    *   `DELETE /graphs/{graph_id}/nodes/{node_id}`: 删除节点。
    *   类似地，还有边的 CRUD 操作。
*   **反馈与讨论**: 
    *   **刘工 (前端)**: 前端需要频繁、局部地更新节点位置、样式或少量属性，全量 `PUT /graphs/{graph_id}` 开销太大且容易冲突。建议增加 `PATCH` 方法支持局部更新，或者提供更细粒度的节点/边属性更新接口。
    *   **王工 (后端)**: 当前设计是典型的 RESTful 风格，简单直接。但考虑到前端画布操作的实时性和细粒度，`PATCH` 或许更合适，但实现复杂度稍高。也可以考虑 WebSocket 进行实时状态同步，但 v0.1 可能过于复杂。
    *   **赵工 (算法)**: 节点属性需要包含模型选择、超参数配置等，当前的 `node.properties` (通用 JSON blob) 是否足够结构化？建议对核心节点类型（数据输入、模型训练、评估等）定义更明确的属性 schema。
    *   **钱工 (产品)**: 需要支持流程图的版本管理和回滚吗？当前 API 似乎没有体现。
*   **结论**: 
    *   **同意**: 增加 `PATCH /graphs/{graph_id}` 用于局部更新（如下一步骤）。
    *   **同意**: 对核心组件节点（如数据源、模型训练、模型评估、部署）的 `properties` 字段定义更明确的 Schema 结构，在 API 文档中详细说明。
    *   **待定**: 版本管理功能（v0.1 暂不实现，后续版本考虑）。
    *   **暂缓**: WebSocket 实时同步（v0.1 之后评估）。

**2. 任务编排与执行 API (`/api/v1/lowcode/tasks`)**

*   **设计概述**: 孙工展示了基于流程图定义创建和执行任务的 API。
    *   `POST /tasks`: 根据 `graph_id` 创建一个任务实例（状态：Pending）。
    *   `GET /tasks/{task_id}`: 获取任务状态和结果。
    *   `POST /tasks/{task_id}/run`: 触发任务执行。
    *   `GET /tasks`: 查询任务列表（支持按状态、时间过滤）。
*   **反馈与讨论**: 
    *   **王工 (后端)**: 任务执行是异步的，`POST /tasks/{task_id}/run` 应该立即返回 202 Accepted。任务状态轮询 (`GET /tasks/{task_id}`) 是标准做法，但也需要考虑长时间运行任务的回调机制（Webhook）。
    *   **赵工 (算法)**: 任务执行时可能需要动态传入参数（如数据集路径、本次运行的特定超参数），API 如何支持？
    *   **张工 (架构师)**: 任务执行的底层是 K8s Job 还是其他调度器？API 需要屏蔽这些细节，但要考虑资源配额、优先级等控制接口。
*   **结论**: 
    *   **同意**: `POST /tasks/{task_id}/run` 返回 202 Accepted。
    *   **同意**: 在 `POST /tasks` 或 `POST /tasks/{task_id}/run` 的请求体中增加 `runtime_parameters` 字段，允许覆盖流程图定义中的默认参数。
    *   **同意**: 考虑增加 Webhook 回调机制，用于通知任务完成或失败（v0.1 可选实现）。
    *   **同意**: API 层面暂不暴露底层调度细节，但后端实现需考虑资源管理接口，为未来扩展预留空间。

**3. 错误处理与一致性**

*   **反馈与讨论**: 
    *   **刘工 (前端)**: API 错误码和错误信息的格式需要统一。
    *   **张工 (架构师)**: 建议遵循标准的 HTTP 状态码，并使用统一的错误响应体结构（如包含 `code`, `message`, `details` 字段）。
*   **结论**: 
    *   **同意**: 制定统一的 API 错误响应规范，并在所有 API 中强制执行。

## 后续行动项

*   **孙工**: 更新 API 设计文档 v0.2，包含以下修改：
    *   为 `/graphs/{graph_id}` 增加 `PATCH` 方法定义。
    *   为核心节点类型定义明确的 `properties` Schema。
    *   明确 `POST /tasks/{task_id}/run` 返回 202 Accepted。
    *   在任务创建或运行 API 中增加 `runtime_parameters` 字段。
    *   （可选）增加 Webhook 设计草案。
*   **孙工**: 制定并分享统一的 API 错误响应规范。
*   **全体**: Review API 设计文档 v0.2 (截止日期: 2023-08-09)。

## 会议结束时间

15:35 