# 医疗数据验证服务功能规格

## 1. 背景与目标

在医疗AI领域，数据质量对模型训练和推理结果至关重要。NovaBrain 3.0平台需要一个专门的医疗数据验证服务，用于确保输入到系统中的各类医疗数据（影像元数据、患者信息、临床指标等）符合预定义的格式规范和业务规则，以保障下游模型和应用的数据质量。

### 核心目标

1. 提供统一的数据验证框架，支持不同类型医疗数据的验证
2. 实现可配置的验证规则，适应不同医疗场景的特殊需求
3. 提供详细的验证报告，帮助用户快速定位和修复数据问题
4. 支持高性能批量验证，满足大规模数据集处理需求
5. 确保符合医疗行业合规要求，包括数据完整性和审计追踪

## 2. 功能需求

### 2.1 基础数据验证器

需要实现一个核心验证器类 `MedicalDataValidator`，具备以下功能：

1. 接收验证规则配置和待验证数据
2. 执行数据验证并返回验证结果
3. 生成详细的验证报告
4. 支持同步和异步验证方式
5. 提供验证统计信息（验证通过率、错误分布等）

### 2.2 验证规则定义与管理

实现验证规则的定义、组合和管理，包括：

1. 预定义常用医疗数据验证规则（如患者ID格式、医学编码有效性、数值范围等）
2. 支持自定义验证规则的注册
3. 规则组合机制，允许创建复合验证规则
4. 规则依赖关系处理，确保按正确顺序执行规则
5. 规则版本管理，支持规则的更新和回滚

### 2.3 验证报告生成

生成详细且结构化的验证报告，包括：

1. 验证摘要（通过/失败记录数、验证时间等）
2. 详细错误列表，包括每条记录的错误位置、类型和描述
3. 按严重程度分类的错误统计
4. 支持多种输出格式（JSON、CSV、PDF等）
5. 针对大型数据集的分段式报告生成

## 3. 技术规格

### 3.1 接口定义

核心验证器接口应包括：

```
validate(data, rules, options): ValidationResult
validateAsync(data, rules, options): Promise<ValidationResult>
validateBatch(dataItems, rules, options): BatchValidationResult
validateBatchAsync(dataItems, rules, options): Promise<BatchValidationResult>
```

其中：
- `data`/`dataItems`: 待验证的数据（单条或批量）
- `rules`: 验证规则集或规则ID
- `options`: 验证选项（如严格模式、最大错误数等）
- 返回结果包含验证状态、错误详情和统计信息

### 3.2 数据模型

核心数据模型包括：

#### ValidationRule
```
{
  id: string,               // 规则唯一标识
  name: string,             // 规则名称
  description: string,      // 规则描述
  category: string,         // 规则分类（如"患者数据"、"影像元数据"等）
  severity: string,         // 严重程度（如"错误"、"警告"、"信息"）
  validationFn: Function,   // 验证函数
  dependencies: string[],   // 依赖的其他规则ID
  errorMessage: string,     // 默认错误消息模板
  version: string           // 规则版本
}
```

#### ValidationResult
```
{
  isValid: boolean,         // 验证是否通过
  errors: ValidationError[],// 验证错误列表
  warnings: ValidationError[],// 验证警告列表
  metadata: {               // 元数据
    validatedAt: Date,      // 验证时间
    duration: number,       // 验证耗时（毫秒）
    rulesApplied: string[]  // 应用的规则ID列表
  }
}
```

#### ValidationError
```
{
  ruleId: string,           // 触发错误的规则ID
  path: string,             // 数据路径（如"patient.id"）
  value: any,               // 错误的值
  message: string,          // 错误消息
  severity: string,         // 严重程度
  metadata: object          // 额外的错误元数据
}
```

#### BatchValidationResult
```
{
  summary: {
    total: number,          // 总记录数
    valid: number,          // 有效记录数
    invalid: number,        // 无效记录数
    validationRate: number  // 验证通过率
  },
  results: ValidationResult[], // 各记录的验证结果
  errorDistribution: {      // 错误分布统计
    byRule: object,         // 按规则统计
    bySeverity: object      // 按严重程度统计
  }
}
```

### 3.3 预定义验证规则

服务应包含以下预定义的医疗数据验证规则：

1. **基础类型验证规则**
   - 必填字段检查
   - 类型检查（字符串、数字、日期等）
   - 格式检查（邮箱、电话、URL等）
   - 长度/范围限制

2. **医疗数据特定规则**
   - 患者ID格式验证
   - 医学编码验证（ICD-10、LOINC、SNOMED CT等）
   - 医疗设备ID验证
   - 实验室检查值范围验证
   - 药物剂量范围验证
   - 日期合理性检查（如出生日期不应在未来）

3. **关联规则**
   - 数据一致性检查（如年龄与出生日期一致）
   - 数据完整性检查（如存在A字段则B字段必填）
   - 条件验证规则（如当性别为女性时，某些特定字段的验证逻辑）

### 3.4 性能要求

- 单条数据验证响应时间不超过50ms
- 批量验证吞吐量不低于1000条/秒
- 内存占用合理，避免大数据集验证时内存溢出
- 支持验证过程的取消和超时控制

## 4. 示例场景

### 场景1：患者基本信息验证

**输入数据**:
```json
{
  "patientId": "P12345678",
  "name": "张三",
  "gender": "M",
  "birthDate": "1980-05-15",
  "height": 175,
  "weight": 70,
  "bloodType": "AB"
}
```

**应用规则**:
- 患者ID格式验证（必须以P开头，后跟8位数字）
- 姓名非空验证
- 性别枚举验证（只能是M、F或U）
- 出生日期格式和合理性验证（必须是有效日期且不在未来）
- 身高范围验证（成人：120-250cm）
- 体重范围验证（成人：30-300kg）
- 血型枚举验证（只能是A、B、AB或O，可带+/-）

**预期验证结果**:
- 验证通过

### 场景2：含错误的CT扫描元数据验证

**输入数据**:
```json
{
  "studyInstanceUID": "1.2.840.113619.2.55.3.123456789",
  "patientId": "P12345678",
  "studyDate": "2023-05-20",
  "modalityType": "CT",
  "sliceThickness": "invalid",
  "kvp": 1500,
  "exposureTime": -100
}
```

**应用规则**:
- DICOM UID格式验证
- 患者ID关联验证
- 模态类型枚举验证
- 层厚数值验证（必须是正数且单位为mm）
- kVp范围验证（CT扫描通常在80-140kV之间）
- 曝光时间正值验证

**预期验证结果**:
- 验证失败，有3个错误：
  1. `sliceThickness`不是有效数值
  2. `kvp`超出正常范围
  3. `exposureTime`不能为负值

## 5. 注意事项与边界条件

开发实现时应特别注意以下几点：

1. **性能考量**
   - 验证规则的执行顺序应优化，将高效规则和必要条件前置
   - 批量验证应考虑内存使用和性能平衡
   - 复杂规则可能需要缓存中间结果以提高性能

2. **错误处理**
   - 验证过程中的异常不应导致整个验证流程崩溃
   - 对于批量验证，单条记录的失败不应影响其他记录
   - 所有异常都应被捕获并转换为适当的验证错误

3. **扩展性**
   - 代码应遵循开闭原则，便于添加新的验证规则
   - 自定义规则注册机制应简单直观
   - 考虑规则的动态加载能力，支持运行时更新规则

4. **医疗行业特殊要求**
   - 所有验证活动应有审计日志，包括谁在何时验证了什么数据
   - 验证结果应可追溯，以支持医疗监管审核
   - 考虑不同医疗场景（如放射、心脏科、儿科等）的特殊验证要求

## 6. 测试要求

为确保验证服务的可靠性，实现应包含全面的测试：

1. **单元测试**
   - 每个验证规则的正向测试（有效数据）
   - 每个验证规则的反向测试（各类无效数据）
   - 边界条件测试（如数值边界、字符串长度边界等）
   - 规则组合测试

2. **集成测试**
   - 完整验证流程测试
   - 批量验证性能测试
   - 错误和异常处理测试

3. **特殊场景测试**
   - 空集合处理
   - 非常大的数据集处理
   - 极端无效数据处理
   - 冲突规则处理

## 7. 实现优先级

功能应按以下优先级实现：

1. 核心验证器框架和基础验证规则
2. 医疗特定验证规则
3. 批量验证与性能优化
4. 详细报告生成
5. 规则管理和版本控制

以上规格为医疗数据验证服务的主要功能需求和技术规格，是进行测试驱动开发的起点。实现团队应首先编写验证这些功能的测试用例，然后逐步实现满足这些测试的代码。 