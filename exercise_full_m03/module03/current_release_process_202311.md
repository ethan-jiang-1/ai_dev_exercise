# NovaBrain 当前发布流程 (截至2023年11月)

**文档版本**: 1.0  
**更新日期**: 2023-11-01  
**负责人**: 王磊 (后端架构负责人)

## 1. 流程概述

目前 NovaBrain 的发布流程主要基于手动和半自动化的步骤，涉及开发、测试、运维和产品团队的协作。流程目标是确保软件质量，并在预定时间内将新版本部署到生产环境。主要痛点在于流程耗时长、易出错、缺乏完整的自动化和环境一致性保障。

## 2. 主要阶段

### 2.1 开发与代码合并

1. **开发分支**: 开发人员在各自的特性分支 (feature branch) 上进行开发。
2. **代码评审**: 通过 Pull Request (PR) 提交代码，至少需要一名其他开发人员或架构师进行评审。
3. **合并到开发分支**: PR 经批准后，代码合并到 `develop` 分支。
4. **单元测试**: 开发人员负责编写和运行单元测试，合并前确保单元测试通过率达到设定阈值 (当前目标 70%)。
5. **CI集成 (部分)**: Jenkins 会在 `develop` 分支合并后自动触发构建和基础单元测试。

### 2.2 测试环境部署与测试

1. **手动部署到测试环境**: QA 团队或开发人员手动从 `develop` 分支拉取最新代码，打包并部署到测试环境。通常每周进行一次或两次。
2. **冒烟测试**: QA 团队执行核心功能的冒烟测试，确保基本流程可用。
3. **功能测试**: QA 团队根据测试用例执行详细的功能测试。
4. **集成测试**: QA 团队测试不同模块之间的交互。
5. **回归测试**: QA 团队执行回归测试用例集，确保新代码没有破坏现有功能。
6. **缺陷管理**: QA 团队在 Jira 中记录发现的 Bug，开发人员修复后，QA 在测试环境验证。
7. **环境差异问题**: 测试环境与生产环境存在配置差异，有时导致测试结果不准确。

### 2.3 UAT (用户验收测试) 环境准备与执行

1. **手动部署到 UAT 环境**: 在测试环境测试相对稳定后，运维团队或开发人员从 `develop` 分支（或创建临时的 release 分支）部署到 UAT 环境。
2. **数据准备**: 手动准备 UAT 所需的测试数据，有时直接使用生产数据的脱敏备份。
3. **UAT 执行**: 产品团队或指定的内部用户在 UAT 环境中执行测试，验证是否满足业务需求。
4. **UAT 反馈处理**: UAT 反馈通过邮件或 Jira 提交，产品和开发团队评估并修复关键问题。

### 2.4 预生产环境部署与验证

1. **创建发布分支**: 从 `develop` 分支创建 `release/vX.Y.Z` 分支。
2. **手动部署到预生产**: 运维团队从 `release` 分支部署到预生产环境 (Staging)。预生产环境配置尽可能与生产环境一致，但资源规模可能较小。
3. **最终验证**: QA 团队和运维团队在预生产环境进行最终的功能验证、配置检查和简单的性能测试。
4. **安全扫描 (手动)**: 安全团队手动对预生产环境进行漏洞扫描。
5. **发布审批**: 产品经理、技术负责人、QA 负责人和运维负责人共同评审预生产环境的测试结果和状态，决定是否批准发布。

### 2.5 生产环境部署

1. **合并到主分支**: `release` 分支代码合并到 `main` 分支，并打上版本 Tag。
2. **部署窗口协调**: 运维团队与业务部门协调确定部署时间窗口 (通常在业务低峰期，如夜间或周末)。
3. **手动执行部署脚本**: 运维团队手动执行一系列部署脚本，逐步更新生产环境的服务。
4. **灰度发布 (有限)**: 对于部分关键服务，会先部署到少数节点进行观察，但缺乏完善的流量切换和监控机制。
5. **部署后监控**: 运维团队和开发人员在部署后密切监控系统日志、错误率和核心业务指标。
6. **回滚计划 (手动)**: 准备手动回滚脚本，如果出现严重问题，手动执行回滚操作。

### 2.6 发布后监控与维护

1. **生产环境监控**: 持续监控生产环境性能和稳定性。
2. **热修复 (Hotfix)**: 如果生产环境出现紧急 Bug，创建 `hotfix` 分支，修复后直接合并到 `main` 和 `develop` 分支，并紧急部署。

## 3. 主要痛点与问题

1. **手动部署繁琐且易错**: 大量手动操作增加了部署时间和出错风险。
2. **环境不一致**: 开发、测试、UAT、生产环境之间存在配置和数据差异，导致测试结果不可靠。
3. **发布周期长**: 从代码合并到最终生产部署，整个流程耗时较长 (通常需要1-2周)。
4. **缺乏自动化测试覆盖**: 自动化测试覆盖率低，特别是集成测试和端到端测试。
5. **CI/CD 流程不完善**: CI 流程仅覆盖基础构建和单元测试，CD 流程基本缺失。
6. **灰度发布和回滚机制不成熟**: 缺乏自动化的流量控制和一键回滚能力。
7. **缺乏统一的发布视图和审计**: 难以追踪每次发布的具体变更和审批记录。
8. **安全检查滞后**: 安全扫描在流程后期进行，发现问题时修复成本高。
9. **依赖管理复杂**: 手动管理服务间的依赖关系和部署顺序。

## 4. 涉及工具

- **代码仓库**: Git (GitLab)
- **CI 服务器**: Jenkins
- **缺陷跟踪**: Jira
- **部署脚本**: Bash, Python (自定义脚本)
- **容器化**: Docker
- **编排**: Kubernetes (手动部署 YAML)
- **监控**: Prometheus, Grafana (配置不完全)
- **沟通**: Slack, Email

## 5. 改进方向 (初步设想)

- 引入完整的 CI/CD 管道 (如 GitLab CI/CD, Argo CD)。
- 使用基础设施即代码 (IaC) 工具 (如 Terraform, Ansible) 管理环境配置。
- 提高自动化测试覆盖率 (集成测试、E2E 测试)。
- 实现自动化的蓝绿部署或金丝雀发布策略。
- 集成自动化安全扫描到 CI 流程。
- 建立统一的发布管理和监控平台。
- 完善日志收集和分析系统。 