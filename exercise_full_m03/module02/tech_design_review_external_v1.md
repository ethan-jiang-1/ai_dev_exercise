# Tech Design Review 外部原始素材 - v1

## 技术趋势

- 当前的模型服务技术主要采用 gRPC 与 REST 实现，关注系统性能、延迟以及微服务架构在大规模部署下的表现。
- 边缘计算、容器化部署、自动扩展等新技术正逐渐应用于模型服务，影响服务的稳定性与扩展性。
- 竞争对手 DataMind 最近采用 Rust 实现了高性能推理服务，在大型模型场景下延迟降低了 40%，我们需要评估是否跟进。

## 竞争格局

- 市场上，部分竞争对手倾向于采用轻量级 REST 接口，而另一些则偏好高效的 gRPC 通信模式。
- 高可用性与低延迟成为竞争的重要指标，不同方案在性能和可扩展性上存在明显差异。
- NovaBrain 需要在医疗场景下确保 99.99% 可用性，这高于行业平均水平(99.9%)，对架构设计提出更高要求。

## 人物画像

- CTO（张弓）：聚焦长期战略和系统架构的扩展性。
- 工程负责人（王强）：关注系统稳定性、运维成本及实施风险。
- 技术负责人（如李工、孙工）：评估技术实现复杂度和选型风险。
- 在上次架构会议中，张弓特别强调了"接口稳定性"和"向后兼容"的重要性，提出模型服务接口需保持 3 年稳定。

## 内部设计参考

- 《tech_design_model_registry_v1.md》和《architecture_decision_record_003_model_serving_grpc_vs_rest.md》记录了模型注册表的设计思路和技术权衡，为评审提供了内部参考。
- 技术债务评估表明，现有的 Python 实现在高并发场景下存在性能瓶颈，需要考虑局部重构或引入性能更优的语言。

## 架构决策详细讨论记录

### 会议：模型注册表架构评审会议（2023-09-20）

**参与人员**：
- 张弓（CTO）
- 王强（工程负责人）
- 李工（前端负责人）
- 孙工（后端负责人）
- 赵工（DevOps 负责人）
- 周工（QA 负责人）

#### gRPC vs REST 讨论摘要

**孙工（后端）**：
> "基于性能测试结果，gRPC 在模型服务场景下比 REST 有 30-40% 的性能优势，特别是在处理大型二进制数据时。然而，我们需要考虑前端集成成本。"

**李工（前端）**：
> "实现 gRPC-Web 将增加前端复杂度，我们缺乏这方面经验。传统 REST 接口对前端更友好，调试也更容易。建议混合使用：核心推理接口使用 gRPC，管理接口保留 REST。"

**赵工（DevOps）**：
> "从运维角度看，gRPC 需要额外的代理配置和监控适配。我们当前的监控工具主要针对 REST 优化。我支持混合方案，但需要明确边界。"

**张弓（CTO）**：
> "考虑到 MediScan 项目的严格延迟要求，核心推理路径必须优化到极致。我同意混合方案，但前提是接口设计必须保持一致性和可预测性。不能让使用者感觉像是两个不同的系统。"

**王强（工程）**：
> "混合方案增加了实现复杂度和测试负担。我们是否评估过使用 GraphQL 作为统一接口层，后端根据性能需求分别实现？"

**结论**：
1. 采用混合架构：推理接口使用 gRPC，管理接口使用 REST
2. 创建统一的接口文档，确保概念和命名的一致性
3. 前端通过适配器模式屏蔽底层实现差异
4. 3个月内完成概念验证，评估是否进一步扩大 gRPC 使用范围

#### 分布式追踪决策

**讨论要点**：
- 模型服务链路长，涉及多个微服务，排障困难
- 现有日志系统难以关联跨服务调用
- 医疗场景要求请求完整可审计

**方案对比**：

| 方案 | 优势 | 劣势 | 工作量 |
|-----|------|------|-------|
| Jaeger | 轻量，易集成 | 存储扩展性一般 | 中 |
| Zipkin | 生态成熟，UI 友好 | 客户端支持有限 | 中 |
| OpenTelemetry | 标准化，前景好 | 相对新，文档不足 | 高 |
| 自研方案 | 完全控制，定制化 | 维护成本高 | 非常高 |

**决策**：采用 OpenTelemetry，尽管工作量较大，但符合行业发展趋势，且支持同时输出到多个后端系统。

## 性能测试数据

### 模型注册表性能基准

| 操作 | 平均响应时间 | P95 响应时间 | P99 响应时间 | 每秒请求数(Max) |
|-----|------------|------------|------------|--------------|
| 模型列表查询 | 85ms | 120ms | 180ms | 350 |
| 模型详情获取 | 45ms | 75ms | 110ms | 750 |
| 模型版本创建 | 230ms | 350ms | 480ms | 120 |
| 模型部署请求 | 350ms | 520ms | 680ms | 80 |
| 批量状态查询 | 150ms | 280ms | 420ms | 200 |

### 负载测试结果

![负载测试曲线](https://placeholder-image.com/load-test-graph.png)

- **测试环境**：AWS m5.2xlarge (8vCPU, 32GB RAM)
- **并发用户**：从 10 增加到 500
- **测试时长**：30分钟阶梯式增加负载

**关键发现**：
1. 在 300 并发用户时，响应时间开始显著增加
2. 数据库连接池在 350 并发时成为瓶颈
3. Redis 缓存未充分利用，命中率仅 45%
4. 模型元数据查询未优化，执行了过多 SQL 查询

## 技术债务分析

### 债务清单

| 领域 | 问题描述 | 影响 | 修复复杂度 | 优先级 |
|-----|---------|------|-----------|-------|
| 代码质量 | 模型版本管理缺乏单元测试，覆盖率低于 30% | 回归风险高 | 中 | 高 |
| 架构 | 使用同步进程间通信进行模型部署，阻塞请求线程 | 可扩展性差，超时风险 | 高 | 高 |
| 性能 | 元数据查询未优化，N+1 查询问题 | 高负载下响应慢 | 中 | 中 |
| 安全 | API 权限粒度过粗，缺乏审计支持 | 无法满足医疗要求 | 高 | 高 |
| 可维护性 | 监控覆盖不全，缺乏关键组件指标 | 问题排查困难 | 低 | 中 |
| 可扩展性 | 存储层与业务逻辑耦合，难以替换 | 限制技术选型 | 高 | 低 |

### 债务趋势图

```
技术债务积累趋势 (T-shirt 尺码估算)

6月 |    M
7月 |    M M
8月 |    M M L
9月 |  S M M L
10月|  S M M L L
    +----------------
      安全 性能 架构 可维护 可扩展
```

### 修复计划

**短期（1-2个Sprint）**：
- 优化元数据查询，解决 N+1 问题
- 添加缺失的监控指标
- 提高单元测试覆盖率

**中期（2-3个月）**：
- 将模型部署改为异步模式
- 重构权限系统，支持细粒度控制
- 实现完整的审计日志

**长期（6个月+）**：
- 存储层抽象化，支持多种后端
- 考虑性能关键路径的语言重构

## 架构风险评估

### 可扩展性风险

- **问题**：现有架构假设模型数量在1万以内，但 MediScan 预计需要管理 10 万+模型版本
- **影响**：搜索、列表功能可能变慢，UI 响应受影响
- **缓解措施**：
  * 实现高级索引和分页
  * 添加缓存层
  * 考虑搜索引擎集成

### 安全合规风险

- **问题**：医疗行业要求可追踪每个模型版本的完整生命周期，当前版本追踪不完整
- **影响**：可能无法满足 MediScan 的合规要求
- **缓解措施**：
  * 实现完整的模型谱系追踪
  * 添加不可变更的操作日志
  * 支持模型与数据的关联关系记录

### 可用性风险

- **问题**：单区域部署无法满足 FinSecure 的高可用要求
- **影响**：区域故障可能导致整体服务不可用
- **缓解措施**：
  * 实现多区域主动-主动部署
  * 设计元数据跨区域同步机制
  * 添加区域故障自动切换

## 技术评估摘要

总体评估：模型注册表设计在功能上满足需求，但在性能、可扩展性和合规性方面存在改进空间。混合通信协议的方案是合理的，但增加了实现复杂度。

### 优势：
- 设计充分考虑了向后兼容性
- 模块化架构便于功能扩展
- 安全机制符合基本要求

### 顾虑：
- 高并发场景下性能风险
- 技术债务积累速度需要控制
- 跨团队协作流程未充分明确

### 下一步建议：
1. 完成性能优化和技术债务消减
2. 明确定义接口契约和向后兼容策略
3. 建立更严格的代码质量标准
4. 实施全面的监控和告警策略 